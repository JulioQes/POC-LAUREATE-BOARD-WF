name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_cross_repo_branch:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:
      - name: Create Branch in Target Repo + Link to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            // Identify BE or FE
            const labels = context.payload.issue.labels.map(label => label.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = '';
            let branchPrefix = '';

            if (labels.includes('BE')) {
              targetRepo = 'POC-LAUREATE-BOARD-BE';
              branchPrefix = 'be/';
            } else if (labels.includes('FE')) {
              targetRepo = 'POC-LAUREATE-BOARD-FE';
              branchPrefix = 'fe/';
            } else {
              console.log("No BE/FE label detected — skipping.");
              return;
            }

            const newBranchName = `${branchPrefix}issue-${issueNumber}-${issueTitle}`;

            try {
              // Get SHA of main in BE/FE repo
              const { data: refData } = await github.rest.git.getRef({
                owner,
                repo: targetRepo,
                ref: `heads/${baseBranch}`
              });

              const sha = refData.object.sha;

              // Create the branch
              await github.rest.git.createRef({
                owner,
                repo: targetRepo,
                ref: `refs/heads/${newBranchName}`,
                sha
              });

              // Link branch to WF Issue (cross-repo allowed in Project V2)
              await github.rest.repos.createOrUpdateIssueBranch({
                owner,
                repo: targetRepo,
                issue_number: issueNumber,
                head_branch: newBranchName
              });

              // Comment on the Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `✅ **Branch created & linked automatically!**

**Repository:** \`${owner}/${targetRepo}\`
**Branch:** \`${newBranchName}\`

This branch is now associated with this Issue under **Development**.`
              });

            } catch (error) {
              core.setFailed(error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `⚠️ **Error creating or linking branch**

\`${error.message}\``
              });
            }
