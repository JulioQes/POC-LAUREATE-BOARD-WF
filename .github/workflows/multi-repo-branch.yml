name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_and_link:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:

      # STEP 1 â€” CREATE BRANCH
      - name: Create branch in BE/FE repo
        id: create_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            const labels = context.payload.issue.labels.map(l => l.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = labels.includes('BE')
                ? 'POC-LAUREATE-BOARD-BE'
                : 'POC-LAUREATE-BOARD-FE';

            const newBranchName = `${labels.includes('BE') ? 'be/' : 'fe/'}issue-${issueNumber}-${issueTitle}`;

            // fetch SHA
            const refData = await github.rest.git.getRef({
              owner,
              repo: targetRepo,
              ref: `heads/${baseBranch}`,
            });

            await github.rest.git.createRef({
              owner,
              repo: targetRepo,
              ref: `refs/heads/${newBranchName}`,
              sha: refData.data.object.sha,
            });

            core.setOutput('targetrepo', targetRepo);
            core.setOutput('branchname', newBranchName);


      # STEP 2 â€” CREATE PR â†’ this links the branch to the Issue
      - name: Create Pull Request to link branch to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const issueNumber = context.payload.issue.number;
            const targetRepo = process.env.REPO;
            const branchName = process.env.BRANCH;

            const pr = await github.rest.pulls.create({
              owner,
              repo: targetRepo,
              title: `Auto: Start work for Issue #${issueNumber}`,
              head: branchName,
              base: 'main',
              body:
                `Automatically created PR\n\n` +
                `Fixes ${context.repo.owner}/${context.repo.repo}#${issueNumber}`
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body:
                `ðŸš€ **Branch created & linked via PR!**\n\n` +
                `**Repository:** ${owner}/${targetRepo}\n` +
                `**Branch:** ${branchName}\n` +
                `**PR:** ${pr.data.html_url}`
            });
        env:
          REPO: ${{ steps.create_branch.outputs.targetrepo }}
          BRANCH: ${{ steps.create_branch.outputs.branchname }}
