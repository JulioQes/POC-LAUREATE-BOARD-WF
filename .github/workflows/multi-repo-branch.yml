name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_branch_and_pr:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:

      ###############################################################
      # STEP 1 â€” CREATE BRANCH + EMPTY COMMIT
      ###############################################################
      - name: Create branch + empty commit
        id: create_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            const labels = context.payload.issue.labels.map(l => l.name);
            const issueNumber = context.payload.issue.number;

            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = '';
            let prefix = '';

            if (labels.includes('BE')) {
              targetRepo = 'POC-LAUREATE-BOARD-BE';
              prefix = 'be/';
            } else {
              targetRepo = 'POC-LAUREATE-BOARD-FE';
              prefix = 'fe/';
            }

            const newBranchName = `${prefix}issue-${issueNumber}-${issueTitle}`;

            // 1 â€” Get SHA of main
            const ref = await github.rest.git.getRef({
              owner,
              repo: targetRepo,
              ref: `heads/${baseBranch}`
            });

            const mainSha = ref.data.object.sha;

            // 2 â€” Get commit info
            const commit = await github.rest.git.getCommit({
              owner,
              repo: targetRepo,
              commit_sha: mainSha
            });

            const treeSha = commit.data.tree.sha;

            // 3 â€” Create branch
            await github.rest.git.createRef({
              owner,
              repo: targetRepo,
              ref: `refs/heads/${newBranchName}`,
              sha: mainSha
            });

            // 4 â€” Create empty commit
            const emptyCommit = await github.rest.git.createCommit({
              owner,
              repo: targetRepo,
              message: "chore: initialize issue branch",
              tree: treeSha,
              parents: [mainSha]
            });

            // 5 â€” Move branch HEAD to empty commit
            await github.rest.git.updateRef({
              owner,
              repo: targetRepo,
              ref: `heads/${newBranchName}`,
              sha: emptyCommit.data.sha,
              force: true
            });

            // Save outputs
            core.setOutput('targetrepo', targetRepo);
            core.setOutput('branchname', newBranchName);
            core.setOutput('commitsha', emptyCommit.data.sha);


      ###############################################################
      # STEP 2 â€” CREATE THE PR USING THE EMPTY COMMIT
      ###############################################################
      - name: Create PR (Draft) with empty commit
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = "JulioQes";
            const issueNumber = context.payload.issue.number;

            const targetRepo = process.env.REPO;
            const branchName = process.env.BRANCH;

            // Create PR
            const pr = await github.rest.pulls.create({
              owner,
              repo: targetRepo,
              title: `WIP: Start work for Issue #${issueNumber}`,
              head: branchName,
              base: "main",
              draft: true,
              body:
                `Automatically initialized branch for Issue #${issueNumber}\n\n` +
                `Fixes ${context.repo.owner}/${context.repo.repo}#${issueNumber}`
            });

            core.setOutput("pr_url", pr.data.html_url);
        env:
          REPO: ${{ steps.create_branch.outputs.targetrepo }}
          BRANCH: ${{ steps.create_branch.outputs.branchname }}


      ###############################################################
      # STEP 3 â€” POST COMMENT IN ORIGINAL ISSUE (it links PR/branch)
      ###############################################################
      - name: Comment in Issue (link PR + branch)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issueNumber = context.payload.issue.number;
            const targetRepo = process.env.REPO;
            const branchName = process.env.BRANCH;
            const prUrl = process.env.PR;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body:
                `ðŸš€ **Branch & PR created automatically!**\n\n` +
                `**Repository:** \`${owner}/${targetRepo}\`\n` +
                `**Branch:** \`${branchName}\`\n` +
                `**Pull Request:** ${prUrl}\n\n` +
                `This PR is linked to the Issue and now visible under **Development**.`
            });
        env:
          REPO: ${{ steps.create_branch.outputs.targetrepo }}
          BRANCH: ${{ steps.create_branch.outputs.branchname }}
          PR: ${{ steps.create_pr.outputs.pr_url }}