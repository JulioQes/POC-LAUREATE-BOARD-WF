name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_and_link_branch:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:

      ##########################################################
      # STEP 1 — CREATE BRANCH IN TARGET REPO (BE/FE)
      ##########################################################
      - name: Create branch in BE/FE repo
        id: create_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            // Identify BE/FE
            const labels = context.payload.issue.labels.map(label => label.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = '';
            let branchPrefix = '';

            if (labels.includes('BE')) {
              targetRepo = 'POC-LAUREATE-BOARD-BE';
              branchPrefix = 'be/';
            } else if (labels.includes('FE')) {
              targetRepo = 'POC-LAUREATE-BOARD-FE';
              branchPrefix = 'fe/';
            }

            const newBranchName = `${branchPrefix}issue-${issueNumber}-${issueTitle}`;

            // Get SHA of main
            const refData = await github.rest.git.getRef({
              owner,
              repo: targetRepo,
              ref: `heads/${baseBranch}`
            });

            const sha = refData.data.object.sha;

            // Create branch
            await github.rest.git.createRef({
              owner,
              repo: targetRepo,
              ref: `refs/heads/${newBranchName}`,
              sha
            });

            // Output for next step
            core.setOutput('targetrepo', targetRepo);
            core.setOutput('branchname', newBranchName);


      ##########################################################
      # STEP 2 — LINK BRANCH TO THE ISSUE
      ##########################################################
      - name: Link created branch to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const issueNumber = context.payload.issue.number;

            const targetRepo = core.getInput('targetrepo', { required: false }) || process.env.INPUT_TARGETREPO;
            const branchName = core.getInput('branchname', { required: false }) || process.env.INPUT_BRANCHNAME;

            // Link branch → Issue (cross repo allowed due to Project V2)
            await github.rest.repos.createOrUpdateIssueBranch({
              owner,
              repo: targetRepo,
              issue_number: issueNumber,
              head_branch: branchName
            });

            // Comment on Issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body:
                '✅ **Branch created & linked automatically!**\n\n' +
                `**Repository:** \`${owner}/${targetRepo}\`\n` +
                `**Branch:** \`${branchName}\`\n\n` +
                'This branch is now associated with this Issue under **Development**.'
            });
        env:
          INPUT_TARGETREPO: ${{ steps.create_branch.outputs.targetrepo }}
          INPUT_BRANCHNAME: ${{ steps.create_branch.outputs.branchname }}
