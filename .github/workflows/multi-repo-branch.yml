name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_and_link_branch:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:
      ###############################################################
      # STEP 1 — CREATE BRANCH + EMPTY COMMIT
      ###############################################################
      - name: Create branch + empty commit
        id: create_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            // Identify BE or FE
            const labels = context.payload.issue.labels.map(l => l.name);
            const issueNumber = context.payload.issue.number;

            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = '';
            let prefix = '';

            if (labels.includes('BE')) {
              targetRepo = 'POC-LAUREATE-BOARD-BE';
              prefix = 'be/';
            } else {
              targetRepo = 'POC-LAUREATE-BOARD-FE';
              prefix = 'fe/';
            }

            const newBranchName = `${prefix}issue-${issueNumber}-${issueTitle}`;

            // 1 — Get SHA of main
            const ref = await github.rest.git.getRef({
              owner,
              repo: targetRepo,
              ref: `heads/${baseBranch}`
            });

            const mainSha = ref.data.object.sha;

            // 2 — Get commit info for main
            const commit = await github.rest.git.getCommit({
              owner,
              repo: targetRepo,
              commit_sha: mainSha
            });

            const treeSha = commit.data.tree.sha;

            // 3 — Create branch
            await github.rest.git.createRef({
              owner,
              repo: targetRepo,
              ref: `refs/heads/${newBranchName}`,
              sha: mainSha
            });

            // 4 — Create empty commit
            const emptyCommit = await github.rest.git.createCommit({
              owner,
              repo: targetRepo,
              message: "chore: initialize issue branch",
              tree: treeSha,
              parents: [mainSha]
            });

            // 5 — Move branch HEAD to empty commit
            await github.rest.git.updateRef({
              owner,
              repo: targetRepo,
              ref: `heads/${newBranchName}`,
              sha: emptyCommit.data.sha,
              force: true
            });

            // Outputs
            core.setOutput('targetrepo', targetRepo);
            core.setOutput('branchname', newBranchName);


      ###############################################################
      # STEP 2 — LINK BRANCH TO ISSUE (appears under Development)
      ###############################################################
      - name: Link branch to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const issueNumber = context.payload.issue.number;
            const owner = 'JulioQes';
            const targetRepo = process.env.TARGET;
            const branchName = process.env.BRANCH;

            // LINK DEVELOPMENT RESOURCE (branch -> Issue)
            // This works because repos are part of same Project V2
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body:
                `✅ **Branch created & linked automatically!**\n\n` +
                `**Repository:** \`${owner}/${targetRepo}\`\n` +
                `**Branch:** \`${branchName}\`\n\n` +
                `This branch will now appear under **Development**.`
            });
        env:
          TARGET: ${{ steps.create_branch.outputs.targetrepo }}
          BRANCH: ${{ steps.create_branch.outputs.branchname }}
