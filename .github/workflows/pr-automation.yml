name: Auto-PR on Project Status Change

on:
  project_item:
    types: [edited]

jobs:
  check_column_and_create_pr:
    runs-on: ubuntu-latest
    
    if: github.event.changes 
      
    steps:
      - name:  Get Issue Details, Calculate Branch, and Create PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }} 
          script: |
            const owner = 'JulioQes';
            
            // 1. Verify if the change was in the 'Status' field.
            if (!context.payload.changes || 
                !context.payload.changes.field_value || 
                !context.payload.changes.field_value.field_value || 
                context.payload.changes.field_value.field_value.field.name !== 'Status') {
                console.log('Change was not a status field change or structure is unexpected. Skipping PR creation.');
                return;
            }
            
            const targetStatus = context.payload.changes.field_value.field_value.field_value.name; // 'DEV' or 'QA'
            
            if (targetStatus !== 'DEV' && targetStatus !== 'QA') {
                console.log(`Target status is ${targetStatus}, not DEV or QA. Skipping PR creation.`);
                return;
            }


            // --- 1. EXTRACT DATA FROM PROJECT EVENT (RESTO DEL SCRIPT ORIGINAL) ---
            const issueNumber = context.payload.changes.field_value.field_value.field_value.issue.number;
            const issueRepo = context.payload.changes.field_value.field_value.field_value.issue.repository.name;
            const sourceIssueRepoOwner = context.payload.changes.field_value.field_value.field_value.issue.repository.owner.login;

            // --- 2. FETCH ISSUE DETAILS (Needed to get BE/FE label and full title) ---
            const { data: issue } = await github.rest.issues.get({
                owner: sourceIssueRepoOwner,
                repo: issueRepo,
                issue_number: issueNumber,
            });

            const labels = issue.labels.map(label => label.name);
            let targetCodeRepo = '';
            let branchPrefix = '';
            
            // Determine the code repository based on labels
            if (labels.includes('BE')) {
                targetCodeRepo = 'POC-LAUREATE-BOARD-BE';
                branchPrefix = 'be/';
            } else if (labels.includes('FE')) {
                targetCodeRepo = 'POC-LAUREATE-BOARD-FE';
                branchPrefix = 'fe/';
            } else {
                console.log('Issue moved but missing BE/FE label. Skipping PR creation.');
                return;
            }

            // --- 3. CALCULATE BRANCH NAMES AND PR TARGET ---
            const prTitle = issue.title;
            const cleanTitle = issue.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-*|-*$/g, '').substring(0, 30);
            const featureBranch = `${branchPrefix}issue-${issueNumber}-${cleanTitle}`; // Head (Source Branch)
            
            // Set the dynamic base branch based on the Project column status
            const baseBranch = (targetStatus === 'DEV') ? 'develop' : 'release'; // Base (Target Branch)
            
            // Adjust PR Title for the target branch
            const dynamicPRTitle = `[${targetStatus} Merge]: ${prTitle}`;

            // --- 4. CREATE THE PULL REQUEST ---
            console.log(`Creating PR for Issue #${issueNumber} in ${targetCodeRepo}, from ${featureBranch} to ${baseBranch}.`);

            try {
                const { data: prData } = await github.rest.pulls.create({
                    owner: owner,
                    repo: targetCodeRepo, 
                    title: dynamicPRTitle,
                    head: featureBranch,  
                    base: baseBranch,     
                    body: `PR created automatically because the issue was moved to the **${targetStatus}** column.\n\nCloses #${issueNumber}`,
                    draft: false, 
                });

                // 5. Comment on the original Issue
                await github.rest.issues.createComment({
                    issue_number: issueNumber,
                    owner: sourceIssueRepoOwner,
                    repo: issueRepo,
                    body: `**Pull Request created** in the repository \`${targetCodeRepo}\` because the issue was moved to **${targetStatus}**.
                    
                    The pull request merges from branch \`${featureBranch}\` into branch \`${baseBranch}\`.                    
                    [View Pull Request](${prData.html_url})`
                });

            } catch (error) {
                // If the feature branch is missing or PR creation fails
                core.setFailed(`PR creation failed when moving to ${targetStatus}. Error: ${error.message}`);
                await github.rest.issues.createComment({
                    issue_number: issueNumber,
                    owner: sourceIssueRepoOwner,
                    repo: issueRepo,
                    body: `**Failed to create the Pull Request** when moving to **${targetStatus}**.
                    **Reason:** ${error.message}.

                    **Checklist:** Please ensure that:
                    1. The branch \`${featureBranch}\` exists in the code repository.
                    2. The branch \`${baseBranch}\` exists in the code repository.
                    3. There are commits in \`${featureBranch}\` that are not in \`${baseBranch}\`.`
                });
            }